# Submetendo Jobs para análise MV (ML) com RaxML

# 3. Submetendo Job para análise MV com RaxML-NG
- Para mais detalhes ao RaxML-NG veja:

-- [github/raxml-ng](https://github.com/amkozlov/raxml-ng)

-- [raxml-ng manual 1](https://isu-molphyl.github.io/EEOB563/computer_labs/lab4/raxml-ng.html)

-- [raxml-ng manual 2](https://cme.h-its.org/exelixis/pubs/krumlov2024_raxng.pdf)

## 3.1 Enviando arquivos para o servidor

No teu terminal (no Windows digite windows+R e em seguida cmd) do teu computador, use:

```bash
# scp -r origem destino
# a pasta filogenia já deve existir no servidor. Para acesso ao servidor veja abaixo.
scp -r /home/user/Downloads/infile.fas SEU_USUARIO@server.ip.address:/home/SEU_USUARIO/filogenia/

# digite a senha do teu usuário quando requisitado
```

O arquivo de exemplo - infile.fas - está em /ML_Jobs.

## 3.2 Acessando o servidor

- Veja os itens 1.1 a 1.3.

## 3.3 Comandos iniciais já no servidor
- Comandos para verificar localização, criar arquivos e editar arquivos:

```bash
# verificar novamente
ls

# deve mostrar no mínimo a presença da pasta filogenia

# entrar na pasta criada
cd filogenia

# a pasta não existe?
mkdir filogenia && cd filogenia
```

## 3.4 Analisando o arquivo de input (.fas) para descobrir quanto recurso computacional será necessário e será alocado no servidor para você nesta análise de ML com RaxML-NG

```bash
pwd
# pwd deve resultar em /home/user/filogenia

ls
# ls deve resultar em input.fas

# rode o raxml-ng para verificar se a matriz .fas está bem editada e verificar quanto de recurso você precisa
raxml-ng --parse --msa input.fas --model GTR+G --prefix parse_result

# inspecione o arquivo de log como abaixo ou já observe em tela as mensagens
nano infile.fas.raxml.log
```
## 3.4.1 As mensagens que importam são como abaixo

- Arquivo: 'infile.fas.raxml.log'
```log
[...]
* Estimated memory requirements                : 28 MB

* Recommended number of threads / MPI processes: 3

Please note that numbers given above are rough estimates only. 
Actual memory consumption and parallel performance on your system may differ!

Alignment can be successfully read by RAxML-NG.
[...]
```
- Primeiro fique atento a 'Alignment can be successfully read by RAxML-NG'.
- Qualquer erro de formatação será notificado aqui.
- Daqui para frente usará as informações contidas em 'Estimated memory requirements' e 'Recommended number of threads / MPI processes'.

## 3.4.2 Configurando o arquivo de submissão de Job no servidor
- Vamos criar e editar o arquivo de submissão.
- O arquivo de exemplo - raxmlng.sub - está em /ML_Jobs.

```bash
sudo nano raxmlng.sub
```

- Ao abrir o editor em raxmlng.sub, cole o conteúdo abaixo (ie.: Ctrl+Shift+V ou Ctrl+V).

```ini
# raxmlng.sub
# Submissão de RaxML-NG via Condor

executable              = /usr/bin/raxml-ng
arguments               = --threads 15 --force perf_threads -msa infile.fas --workers 15 --bs-trees autoMRE{1000} --seed 12345 --all --prefix result --model GTR+G

log                     = raxmlng.log
output                  = raxmlng.out
error                   = raxmlng.err

should_transfer_files   = NO

request_cpus            = 15
request_memory          = 2G
request_disk            = 2G

queue
```
Após colar o conteúdo, salve usando "Ctrl+X" em seguida "y" ou "s" e por fim "Enter".

## 3.4.3 Explicando os valores do arquivo de submissão (raxmlng.sub)

- Baseado no arquivo: 'infile.fas.raxml.log'

```log
[...]
* Estimated memory requirements                : 28 MB

* Recommended number of threads / MPI processes: 3
```

- O arquivo de 'raxmlng.sub' poderia ser:

```ini
#[...]
request_cpus            = 3
request_memory          = <1G
request_disk            = <1G
queue
```

- No entanto o servidor tem capacidade para mais e alocação mínima pode ser como abaixo. A alocação máxima deve ser 24 cpus. Datasets muito pequenos são prejudicadas com muitos cpus.

```ini
#[...]
request_cpus            = 15
request_memory          = 10G
request_disk            = 10G
queue
```

## 3.4.4 Submetendo raxmlng.sub

```bash
cd filogenia

condor_submit raxmlng.sub

# Anote o número do job como do exemplo abaixo: 16
# Submitting job(s).
#1 job(s) submitted to cluster 16.

# verifique o status do teu job com
condor_q

# espere alguns segundos
# deve aparecer na coluna RUN
# passou um minuto e não foi para RUN
# se estiver em IDLE pode ser que não tem recursos disponíveis e quando houver o condor se engarregará de colocar para rodar
# se estiver em HOLD, a submissão de job pede algo que não existe no servidor
# para mais detalhes você pode verificar o arquivo .err

```

## 3.4.5 Arquivos de saída

- Os arquivos de saída são como abaixo

Best ML tree with collapsed near-zero branches saved to: ./result.raxml.bestTreeCollapsed
Best ML tree saved to: ./result.raxml.bestTree
All ML trees saved to: ./result.raxml.mlTrees
Best ML tree with Felsenstein bootstrap (FBP) support values saved to: ./result.raxml.support
Optimized model saved to: ./result.raxml.bestModel
Bootstrap trees saved to: ./result.raxml.bootstraps

- Transfira e use o arquivo './result.raxml.support' para abrir no Figtree ou outro sistema de verificação ou análise