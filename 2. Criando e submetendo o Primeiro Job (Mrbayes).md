# 2. Criando e Submetendo o Primeiro Job (Mrbayes)

## 2.1 Enviando arquivos para o servidor

No teu terminal (no Windows digite windows+R e em seguida cmd) do teu computador, use:

```bash
# scp -r origem destino
scp -r /home/user/Downloads/infile.nex SEU_USUARIO@server.ip.address:/home/SEU_USUARIO/filogenia/

# digite a senha do teu usuário quando requisitado
```

O arquivo de exemplo - infile.nex - está em /MrBayes_Jobs.

## 2.2 Comandos iniciais já no servidor
- Comandos para verificar localização, criar arquivos e editar arquivos:

```bash
# verificar novamente
ls

# deve mostrar a presença da pasta filogenia e do arquivo .nex

# entrar na pasta criada
cd filogenia

sudo nano mrbayes.sub
```

## 2.3 Ao abrir o editor em mrbayes.sub, cole o conteúdo abaixo (ie.: Ctrl+Shift+V ou Ctrl+V).

```ini
# mrbayes.sub
# Submissão de MrBayes via Condor

executable              = /usr/bin/mpirun
arguments               = --mca plm isolated --oversubscribe -np 8 /usr/local/bin/mb infile.nex

log                     = mrbayes.log
output                  = mrbayes.out
error                   = mrbayes.err

should_transfer_files   = NO

request_cpus            = 8
request_memory          = 6G
request_disk            = 7G

queue
```
Após colar o conteúdo, salve usando "Ctrl+X" em seguida "y" ou "s" e por fim "Enter".

## 2.4 De volta ao terminal:
```bash
condor_submit mrbayes.sub

# Anote o número do job como do exemplo abaixo: job nº 16
# | Submitting job(s).
# | 1 job(s) submitted to cluster 16.

# verifique se o teu job foi submetido e se está rodando (em RUN)
condor_q

# Caso não apareça nada ou o job fique com HELD e não HOLD, verifique o arquivo de erro
# use cat para ver o conteúdo do arquivo sem abrir um leitor
cat mrbayes.err

# ou
# use nano para ler em uma janela específica com direito à edição
nano mrbayes.err

# se estiver em IDLE pode ser que não tem recursos disponíveis e quando houver o condor se engarregará de colocar para rodar
# se estiver em HOLD, a submissão de job pede algo que não existe no servidor
# para mais detalhes você pode verificar o arquivo .err
```

## 2.5 O arquivo mrbayes.sub pode ser criado e editado no teu computador e ser transferido junto com o infile.nex

Encontre o exemplo em /MrBayes Jobs.

```bash
# múltiplos | pedirá autenticação a cada arquivo
# scp -r origem destino
scp -r /home/user/Downloads/**{infile.nex,mrbayes.sub}** SEU_USUARIO@server.ip.address:/home/SEU_USUARIO/filogenia/
```

## 2.6 Acompanhando o Job, verificando resultados e download

```bash
# Pelo número doj job, verifique se ainda está em RUN ou na fila (HOLD ou IDLE)
condor_q

# No terminal
cd filogenia

ls

# Verifique os arquivos presentes

# Verifique o output
# Use nano se preferir ao invés de cat
cat mrbayes.out
#or
cat mrbayes.log

```

## 2.7 Verificou que a corrida conclui ou você encontrou o arquivo .tre. Vamos transferir os arquivos necessários para o teu computador e verificar os arquivos .p no TRACER e a .tre no FIGTREE.

Corrida foi concluída? Veja no mrbayes.out se terminou como esperado e/ou como abaixo:

```out
   ...
   Calculating tree probabilities...

   Credible sets of trees (2485 trees sampled):
      50 % credible set contains 98 trees
      90 % credible set contains 744 trees
      95 % credible set contains 1230 trees
      99 % credible set contains 2185 trees

   Exiting mrbayes block
   Reached end of file

   Tasks completed, exiting program because mode is noninteractive
   To return control to the command line after completion of file processing, 
   set mode to interactive with 'mb -i <filename>' (i is for interactive)
   or use 'set mode=interactive'
```

Transferindo os arquivos para o teu computador.

```bash
# No terminal do teu computador use:
# Toda a pasta será copiada.
scp -r SEU_USUARIO@server.ip.address:/home/SEU_USUARIO/filogenia/ /home/user/Downloads/

# ou
# Arquivos alvo selecionados serão copiados. Poderá ser pedido a senha de acesso ao servidor a cada arquivo.
scp -r SEU_USUARIO@server.ip.address:/home/SEU_USUARIO/filogenia/**{infile.nex,infile.nex.con.tre,infile.nex.run1.p,infile.nex.run2.p,mrbayes.out}** /home/user/Downloads/filogenia_genusX
```

## Existem alternativas de manipulação de vários arquivos. Veja algumas possibilidades em 6. Manipulação de arquivos.
