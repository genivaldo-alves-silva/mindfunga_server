# 4 Submetendo Jobs para análise MV (ML) com IQTree

- Para mais detalhes ao IQTree veja:

-- [IQTree Minimal command-line examples](https://iqtree.github.io/doc/Quickstart#installation)  
-- [IQTree Beginner’s tutorial](https://iqtree.github.io/doc/Tutorial)  
-- [ChatGPT focado no IQTree](https://chatgpt.com/g/g-aZvnPPUW1-iq-gpt)  

## 4.1 Enviando arquivos para o servidor

No teu terminal (no Windows digite windows+R e em seguida cmd) do teu computador, use:

```bash
# scp -r origem destino
# a pasta filogenia já deve existir no servidor. Para acesso ao servidor veja em 3.2.
scp -r /home/user/Downloads/infile.fas SEU_USUARIO@server.ip.address:/home/SEU_USUARIO/filogenia/

# digite a senha do teu usuário quando requisitado
```

O arquivo de exemplo - infile.fas - está em `./ML_Jobs`.

## 4.2 Acessando o servidor

- Veja os itens 1.1 a 1.3.

## 4.3 Comandos iniciais já no servidor
- Comandos para verificar localização, criar arquivos e editar arquivos:

```bash
# verificar novamente
ls

# deve mostrar no mínimo a presença da pasta filogenia

# entrar na pasta criada
cd filogenia

# a pasta não existe? Crie e abra-a
mkdir filogenia && cd filogenia
```

## 4.4 Configurando o arquivo de submissão de Job no servidor
- Vamos criar e editar o arquivo de submissão.
- O arquivo de exemplo - iqtree.sub - está em `./ML_Jobs`.

```bash
sudo nano iqtree.sub
```

- Ao abrir o editor em iqtree.sub, cole o conteúdo abaixo (ie.: Ctrl+Shift+V ou Ctrl+V).

```ini
# iqtree.sub
# Submissão de IQTree via Condor

executable              = /usr/local/bin/iqtree3
arguments               = -s infile.fas -B 1000 -alrt 1000 -T 2

log                     = iqtree3.log
output                  = iqtree3.out
error                   = iqtree3.err

should_transfer_files   = NO

request_cpus            = 2
request_memory          = 2G
request_disk            = 2G

queue
```
Após colar o conteúdo, salve usando "Ctrl+X" em seguida "y" ou "s" e por fim "Enter".

## 4.5 Explicando os valores do arquivo de submissão (iqtree.sub)

- Da linha:

```ini
arguments               = -s infile.fas -B 1000 -alrt 1000 -T 2
```

-B 1000: 1000 iterações de Bootstrap;  
-alrt 1000: O SH-aLRT mede quão fortemente os dados apoiam cada ramo interno da árvore. Os valores variam de 0 a 100. O IQ-TREE recomenda usar junto com Bootstrap. No arquivo de saída `./treefile` aparecem valores SH-aLRT e bootstrap nos ramos;  
-T 2: O parâmetro -T é utilizado para definir quantas cpus serão utilizadas. Quando alterada, deve ser alterado também em "request_cpus".  

- Como escolher o melhor número? Números altos muitas vezes aumentam o tempo de processamento, pois há um esforço para a comunicação de resultados de cálculos entre os threads (cpus). Ou seja, se escolhido 10 ao invés de 2, 2 poderá mais rápido.
- Há dois caminhos para definir o valor de -T (e request_cpus):

    - 1. Com base nos números gerais da matriz:
        Para até 100 terminais e 1000 pb, use -T = 2;  
        Para em torno de 200 terminais e até 2000 pb, use -T = 4;  
        Para matrizes maiores que 3000 pb, use -T = 6.
    - 2. Usando o software RAxML-NG para calcular o melhor cenário. Veja abaixo.

## 4.5.1 Analisando o arquivo de input (.fas) para descobrir quanto recurso computacional será necessário e será alocado no servidor para você nesta análise de ML com RAxML-NG

```bash
pwd
# pwd deve resultar em /home/user/filogenia

ls
# ls deve resultar em input.fas

# rode o raxml-ng para verificar se a matriz .fas está bem editada e verificar quanto de recurso você precisa
raxml-ng --parse --msa input.fas --model GTR+G --prefix parse_result

# inspecione o arquivo de log como abaixo ou já observe em tela as mensagens
cat infile.fas.raxml.log
```
## 4.5.2 As mensagens que importam são como abaixo

- Arquivo: `./infile.fas.raxml.log`.
```log
[...]
* Estimated memory requirements                : 28 MB

* Recommended number of threads / MPI processes: 3

Please note that numbers given above are rough estimates only. 
Actual memory consumption and parallel performance on your system may differ!

Alignment can be successfully read by RAxML-NG.
[...]
```
- Ou seja, neste caso -T = 3.

- Mesmo que a matriz requeira, -T não deve exceder 10. Lembre-se que está usando um equipamento compartilhado.

## 4.6 Submetendo iqtree.sub

```bash
cd filogenia

condor_submit iqtree.sub

# Anote o número do job como do exemplo abaixo: job nº 16
# | Submitting job(s).
# | 1 job(s) submitted to cluster 16.

# verifique o status do teu job com
condor_q

# espere alguns segundos
# deve aparecer na coluna RUN
# passou um minuto e não foi para RUN
# se estiver em IDLE pode ser que não tem recursos disponíveis e quando houver o condor se engarregará de colocar para rodar
# se estiver em HOLD, a submissão de job pede algo que não existe no servidor
# para mais detalhes você pode verificar o arquivo .err

```

## 3.4.5 Arquivos de saída

- Analysis results written to: 
  - IQ-TREE report:                             `./infile.fas.iqtree`.
  - Maximum-likelihood tree (com SH-aLRT e BS): `./infile.fas.treefile`
  - Likelihood distances:                       `./infile.fas.mldist`.

- Ultrafast bootstrap approximation results written to:
  - Split support values:                       `./infile.fas.splits.nex`
  - Consensus tree (com BS):                    `./infile.fas.contree`
  - Screen log file:                            `./infile.fas.log`
