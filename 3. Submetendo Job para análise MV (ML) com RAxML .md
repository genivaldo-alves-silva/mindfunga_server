# Submetendo Jobs para análise MV (ML) com RAxML
- Se quiser rodar o clássico como no CIPRES, onde usava RAxML-HPC v.8 on ACCESS, com 'Rapid bootstrap analysis / search for best-scoring ML tree (-f a)', vá para o item 3.5.

# 3. Submetendo Job para análise MV com RAxML-NG (Next Generation)
- Para mais detalhes ao RaxML-NG veja:

-- [github/raxml-ng](https://github.com/amkozlov/raxml-ng)  
-- [raxml-ng manual 1](https://isu-molphyl.github.io/EEOB563/computer_labs/lab4/raxml-ng.html)  
-- [raxml-ng manual 2](https://cme.h-its.org/exelixis/pubs/krumlov2024_raxng.pdf)  

## 3.1 Enviando arquivos para o servidor

No teu terminal (no Windows digite windows+R e em seguida cmd) do teu computador, use:

```bash
# scp -r origem destino
# a pasta filogenia já deve existir no servidor. Para acesso ao servidor veja em 3.2.
scp -r /home/user/Downloads/infile.fas SEU_USUARIO@server.ip.address:/home/SEU_USUARIO/filogenia/

# digite a senha do teu usuário quando requisitado
```

O arquivo de exemplo - infile.fas - está em `./ML_Jobs`.

## 3.2 Acessando o servidor

- Veja os itens 1.1 a 1.3.

## 3.3 Comandos iniciais já no servidor
- Comandos para verificar localização, criar arquivos e editar arquivos:

```bash
# verificar novamente
ls

# deve mostrar no mínimo a presença da pasta filogenia

# entrar na pasta criada
cd filogenia

# a pasta não existe? Crie e abra-a
mkdir filogenia && cd filogenia
```

## 3.4 Analisando o arquivo de input (.fas) para descobrir quanto recurso computacional será necessário e será alocado no servidor para você nesta análise de ML com RAxML-NG

```bash
pwd
# pwd deve resultar em /home/user/filogenia

ls
# ls deve resultar em input.fas

# rode o raxml-ng para verificar se a matriz .fas está bem editada e verificar quanto de recurso você precisa
raxml-ng --parse --msa input.fas --model GTR+G --prefix parse_result

# inspecione o arquivo de log como abaixo ou já observe em tela as mensagens
nano infile.fas.raxml.log
```
## 3.4.1 As mensagens que importam são como abaixo

- Arquivo: `./infile.fas.raxml.log`.
```log
[...]
* Estimated memory requirements                : 28 MB

* Recommended number of threads / MPI processes: 3

Please note that numbers given above are rough estimates only. 
Actual memory consumption and parallel performance on your system may differ!

Alignment can be successfully read by RAxML-NG.
[...]
```
- Primeiro fique atento a 'Alignment can be successfully read by RAxML-NG'.
- Qualquer erro de formatação será notificado aqui.
- Daqui para frente usará as informações contidas em 'Estimated memory requirements' e 'Recommended number of threads / MPI processes'.

## 3.4.2 Configurando o arquivo de submissão de Job no servidor
- Vamos criar e editar o arquivo de submissão.
- O arquivo de exemplo - raxmlng.sub - está em `./ML_Jobs`.

```bash
sudo nano raxmlng.sub
```

- Ao abrir o editor em raxmlng.sub, cole o conteúdo abaixo (ie.: Ctrl+Shift+V ou Ctrl+V).

```ini
# raxmlng.sub
# Submissão de RaxML-NG via Condor

executable              = /usr/local/bin/raxml-ng
arguments               = --threads 4 --force perf_threads -msa infile.fas --workers 4 --bs-trees autoMRE{1000} --seed 12345 --all --prefix result --model GTR+G

log                     = raxmlng.log
output                  = raxmlng.out
error                   = raxmlng.err

should_transfer_files   = NO

request_cpus            = 4
request_memory          = 2G
request_disk            = 2G

queue
```
Após colar o conteúdo, salve usando "Ctrl+X" em seguida "y" ou "s" e por fim "Enter".

## 3.4.3 Explicando os valores do arquivo de submissão (raxmlng.sub)

- Baseado no arquivo: `./infile.fas.raxml.log`.

```log
[...]
* Estimated memory requirements                : 28 MB

* Recommended number of threads / MPI processes: 3
```

- O arquivo de 'raxmlng.sub' poderia ser:

```ini
#[...]
request_cpus            = 3
request_memory          = <1G
request_disk            = <1G
queue
```

- Mas por segurança e alguma folga, arredonde para cima até o próximo número par e fixe RAM e HD como abaixo. O número máximo para request_cpus é de 15.

```ini
#[...]
request_cpus            = 4
request_memory          = 2G
request_disk            = 2G
queue
```

- Atente-se para mudar também as opções abaixo na linha 'Arguments', que devem ser igual a 'request_cpus'.

```ini
arguments               = --threads 4 --workers 4
```

## 3.4.4 Submetendo raxmlng.sub

```bash
cd filogenia

condor_submit raxmlng.sub

# Anote o número do job como do exemplo abaixo: job nº 16
# | Submitting job(s).
# | 1 job(s) submitted to cluster 16.

# verifique o status do teu job com
condor_q

# espere alguns segundos
# deve aparecer na coluna RUN
# passou um minuto e não foi para RUN
# se estiver em IDLE pode ser que não tem recursos disponíveis e quando houver o condor se engarregará de colocar para rodar
# se estiver em HOLD, a submissão de job pede algo que não existe no servidor
# para mais detalhes você pode verificar o arquivo .err

```

## 3.4.5 Arquivos de saída

- Os arquivos de saída são como abaixo

Results/Bootstrap information saved to: `./raxmlng.out`.  
Best ML tree with collapsed near-zero branches saved to: `./result.raxml.bestTreeCollapsed`  
Best ML tree saved to: `./result.raxml.bestTree`  
All ML trees saved to: `./result.raxml.mlTrees`  
Best ML tree with Felsenstein bootstrap (FBP) support values saved to: `./result.raxml.support`  
Optimized model saved to: `./result.raxml.bestModel`  
Bootstrap trees saved to: `./result.raxml.bootstraps`  

- Transfira e use o arquivo `./result.raxml.support` para abrir no Figtree ou outro sistema de verificação ou análise

## 3.5 Submetendo Jobs para análise MV (ML) com RAxML-HPC

## 3.5.1 Analisando o arquivo de input (.fas) para descobrir quanto recurso computacional será necessário e será alocado no servidor para você nesta análise de ML com RAxML-HPC

```bash
pwd
# pwd deve resultar em /home/user/filogenia

ls
# ls deve resultar em input.fas

# rode o raxml-ng para verificar se a matriz .fas está bem editada e verificar quanto de recurso você precisa
raxml-ng --parse --msa input.fas --model GTR+G --prefix parse_result

# inspecione o arquivo de log como abaixo ou já observe em tela as mensagens
nano infile.fas.raxml.log
```

## 3.5.2 As mensagens que importam são como abaixo

- Arquivo: `./infile.fas.raxml.log`.
```log
[...]
* Estimated memory requirements                : 28 MB

* Recommended number of threads / MPI processes: 3

Please note that numbers given above are rough estimates only. 
Actual memory consumption and parallel performance on your system may differ!

Alignment can be successfully read by RAxML-NG.
[...]
```
- Primeiro fique atento a 'Alignment can be successfully read by RAxML-NG'.
- Qualquer erro de formatação será notificado aqui.
- Daqui para frente usará as informações contidas em 'Estimated memory requirements' e 'Recommended number of threads / MPI processes'.

## 3.5.3 Configurando o arquivo de submissão de Job no servidor
- Vamos criar e editar o arquivo de submissão.
- O arquivo de exemplo - raxmlhpc.sub - está em `./ML_Jobs`.

```bash
sudo nano raxmlhpc.sub
```

- Ao abrir o editor em raxmlhpc.sub, cole o conteúdo abaixo (ie.: Ctrl+Shift+V ou Ctrl+V).

```ini
# raxmlhpc.sub
# Submissão de RaxMLHPC via Condor

executable              = /usr/local/bin/raxmlHPC
arguments               = -T 4 -f a -N autoMRE -n result -s infile.fas -c 25 -m GTRGAMMA -p 12345 -x 12345

log                     = raxmlhpc.log
output                  = raxmlhpc.out
error                   = raxmlhpc.err

should_transfer_files   = NO

request_cpus            = 4
request_memory          = 2G
request_disk            = 2G

queue
```
Após colar o conteúdo, salve usando "Ctrl+X" em seguida "y" ou "s" e por fim "Enter".

## 3.5.4 Explicando os valores do arquivo de submissão (raxmlhpc.sub)

- Baseado no arquivo: `./infile.fas.raxml.log`.

```log
[...]
* Estimated memory requirements                : 28 MB

* Recommended number of threads / MPI processes: 3
```

- O arquivo de 'raxmlhpc.sub' poderia ser:

```ini
#[...]
request_cpus            = 3
request_memory          = <1G
request_disk            = <1G
queue
```

- Mas por segurança e alguma folga, arredonde para cima até o próximo número par e fixe RAM e HD como abaixo. O número máximo para request_cpus é de 15.

```ini
#[...]
request_cpus            = 4
request_memory          = 2G
request_disk            = 2G
queue
```

- Atente-se para mudar também a opção abaixo na linha 'Arguments', que deve ser igual a 'request_cpus'.

```ini
arguments               = -T 4
```

## 3.5.5 Submetendo raxmlhpc.sub

```bash
cd filogenia

condor_submit raxmlhpc.sub

# Anote o número do job como do exemplo abaixo: job nº 16
# | Submitting job(s).
# | 1 job(s) submitted to cluster 16.

# verifique o status do teu job com
condor_q

# espere alguns segundos
# deve aparecer na coluna RUN
# passou um minuto e não foi para RUN
# se estiver em IDLE pode ser que não tem recursos disponíveis e quando houver o condor se engarregará de colocar para rodar
# se estiver em HOLD, a submissão de job pede algo que não existe no servidor
# para mais detalhes você pode verificar o arquivo .err

```

## 3.5.6 Arquivos de saída

- Os arquivos de saída são como abaixo.

Results/Bootstrap/Program execution info written to `./RAxML_info.result`.  
All X bootstrapped trees written to: `./RAxML_bootstrap.result`.  
Best-scoring ML tree written to: `./RAxML_bestTree.result`.  
Best-scoring ML tree with support values written to: `./RAxML_bipartitions.result`.  
Best-scoring ML tree with support values as branch labels written to: `./RAxML_bipartitionsBranchLabels.result`.  

- Transfira e use o arquivo `./RAxML_bipartitions.result` para abrir no Figtree ou outro sistema de verificação ou análise.